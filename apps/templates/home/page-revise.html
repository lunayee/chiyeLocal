{% extends "layouts/base.html" %}

{% block title %} 校正資料 {% endblock %}

{% block stylesheets %}
<link type="text/css" href="/static/assets/css/custom.css" rel="stylesheet">{% endblock stylesheets %}

{% block content %}
<!--連結後台函數 儲存校正過後測值-->
<div class="d-flex align-items-center py-4">
    <div class="d-block mb-4 mb-md-0">
        <nav aria-label="breadcrumb" class="d-none d-md-inline-block">
            <ol class="breadcrumb breadcrumb-dark breadcrumb-transparent">
                <li class="breadcrumb-item">
                    <a href="/DashBoard.html">
                        <svg class="icon icon-xxs" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                            </path>
                        </svg>
                    </a>
                </li>
                <li class="breadcrumb-item"><a href="/DashBoard.html">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">校正資料</li>
            </ol>
        </nav>
    </div>
</div>
<div>
    <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#exampleModal">
        <svg class="icon icon-sm me-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd"
                d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                clip-rule="evenodd"></path>
        </svg>
        顯示欄位
    </button>
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">選擇要顯示的測項</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12 col-sm-12 col-xl-12 d-flex flex-wrap ">
                            {% for key, value in Data.items %}
                                <div class="form-check  form-control-lg d-flex flex-row col-12 col-xl-6 ">
                                    <input class="form-check-input me-2" type="checkbox" id="{{key}}_checkbox" checked>
                                    <label class="form-check-label" for="{{key}}_name">{{key}}：</label>
                                    <input class="input-underline pb-2" type="text" id="{{key}}_name" value={{value}}>
                                </div>
                            {% endfor %}
                            

                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="item_check">確定</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12 col-sm-6 col-md-6 mb-2">
        <div class="card card-body border-3 shadow mb-4">
            <div class="d-lg-flex mb-0">
                <div class="fs-3  me-auto">
                    <select class="form-select" id="table1_0" aria-label="Item" style="font-size: 18px;">
                        <option value=1 selected>選擇測項　　</option>
                        {% for key, value in Data.items %}
                        <option value={{key}}>{{value}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="d-flex flex-lg-column flex-xl-row align-items-end fs-7 ms-2">
                    <div class="mx-1">
                        <span>a：</span>
                        <span id="a"></span>
                    </div>
                    <div class="mx-1">
                        <span>b：</span>
                        <span id="b"></span>
                    </div>
                    <div class="mx-1">
                        <span>offset：</span>
                        <span id="offset"></span>
                    </div>
                </div>
            </div>
            <div role="separator" class="dropdown-divider mb-2 mt-2"></div>
            <div class="row mb-2">
                <div class="col-6 form-floating px-1 py-1">
                    <input type="text" class="form-control h-rem-3" id="input1" placeholder="Value" required>
                    <label for="value1_1">Value_zero</label>
                </div>
                <div class="col-6 form-floating px-1 py-1">
                    <input type="text" class="form-control h-rem-3" id="input2" placeholder="Value">
                    <label for="value1_2">Value_span</label>
                </div>
                <div class="col-6 form-floating px-1 py-1">
                    <input type="text" class="form-control h-rem-3" id="input3" placeholder="Value">
                    <label for="value1_3">Count_zero</label>
                </div>
                <div class="col-6 form-floating px-1 py-1">
                    <input type="text" class="form-control h-rem-3" id="input4" placeholder="Value">
                    <label for="value1_4">Count_span</label>
                    <div></div>
                </div>
                <div class="col-6 form-floating px-1 py-1">
                    <input type="text" class="form-control h-rem-3" id="input5" placeholder="offset">
                    <label for="value1_5">offset</label>
                    <div></div>
                </div>
            </div>
            <div class="row mb-2">
                <div class="col-5 px-1 py-1 text-center fw-bold">
                    <div class="fs-7 text-gray-500">Before</div>
                    <div class="fs-3" id="Value_be">000</div>
                </div>
                <div class="col-2 icon ps-0 mt-2">
                    <svg width="60" height="60" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 128 128">
                        <path fill="#fff" d="M64 14A50 50 0 1 0 64 114A50 50 0 1 0 64 14Z"></path>
                        <path fill="#444b54"
                            d="M64,117c-29.2,0-53-23.8-53-53s23.8-53,53-53s53,23.8,53,53S93.2,117,64,117z M64,17c-25.9,0-47,21.1-47,47s21.1,47,47,47s47-21.1,47-47S89.9,17,64,17z">
                        </path>
                        <path fill="#444b54"
                            d="M80 67H55c-1.7 0-3-1.3-3-3s1.3-3 3-3h25c1.7 0 3 1.3 3 3S81.7 67 80 67zM45 67c-.2 0-.4 0-.6-.1-.2 0-.4-.1-.6-.2-.2-.1-.3-.2-.5-.3-.2-.1-.3-.2-.5-.4C42.3 65.6 42 64.8 42 64s.3-1.6.9-2.1c.1-.1.3-.3.4-.4.2-.1.3-.2.5-.3.2-.1.4-.1.6-.2 1-.2 2 .1 2.7.8.6.6.9 1.3.9 2.1s-.3 1.6-.9 2.1c-.1.1-.3.3-.5.4-.2.1-.3.2-.5.3-.2.1-.4.1-.6.2C45.4 67 45.2 67 45 67z">
                        </path>
                        <path fill="#444b54"
                            d="M70,77c-0.8,0-1.5-0.3-2.1-0.9c-1.2-1.2-1.2-3.1,0-4.2l7.9-7.9l-7.9-7.9c-1.2-1.2-1.2-3.1,0-4.2c1.2-1.2,3.1-1.2,4.2,0l10,10c1.2,1.2,1.2,3.1,0,4.2l-10,10C71.5,76.7,70.8,77,70,77z">
                        </path>
                    </svg>
                    <path fill="#fff" d="M64 14A50 50 0 1 0 64 114A50 50 0 1 0 64 14Z"></path>
                    <path fill="#444b54"
                        d="M64,117c-29.2,0-53-23.8-53-53s23.8-53,53-53s53,23.8,53,53S93.2,117,64,117z M64,17c-25.9,0-47,21.1-47,47s21.1,47,47,47s47-21.1,47-47S89.9,17,64,17z">
                    </path>
                    <path fill="#444b54"
                        d="M80 67H55c-1.7 0-3-1.3-3-3s1.3-3 3-3h25c1.7 0 3 1.3 3 3S81.7 67 80 67zM45 67c-.2 0-.4 0-.6-.1-.2 0-.4-.1-.6-.2-.2-.1-.3-.2-.5-.3-.2-.1-.3-.2-.5-.4C42.3 65.6 42 64.8 42 64s.3-1.6.9-2.1c.1-.1.3-.3.4-.4.2-.1.3-.2.5-.3.2-.1.4-.1.6-.2 1-.2 2 .1 2.7.8.6.6.9 1.3.9 2.1s-.3 1.6-.9 2.1c-.1.1-.3.3-.5.4-.2.1-.3.2-.5.3-.2.1-.4.1-.6.2C45.4 67 45.2 67 45 67z">
                    </path>
                    <path fill="#444b54"
                        d="M70,77c-0.8,0-1.5-0.3-2.1-0.9c-1.2-1.2-1.2-3.1,0-4.2l7.9-7.9l-7.9-7.9c-1.2-1.2-1.2-3.1,0-4.2c1.2-1.2,3.1-1.2,4.2,0l10,10c1.2,1.2,1.2,3.1,0,4.2l-10,10C71.5,76.7,70.8,77,70,77z">
                    </path>
                </div>
                <div class="col-5 px-1 py-1 text-center fw-bold">
                    <div class="fs-7 text-gray-500">After</div>
                    <div class="fs-3" id="Value_af">000</div>
                </div>
            </div>
            <div class="d-flex justify-content-end">
                <button class="btn btn-gray-800 mt-2 animate-up-2 " type="submit" id="table_save">儲存</button>
            </div>
        </div>
    </div>

    <div>
        {% endblock content %}

        <!-- Specific Page JS goes HERE  -->
        {% block javascripts %}
        <script>
            const Toast = Swal.mixin({
                toast: true,
                position: 'top',
                showConfirmButton: false,
                timer: 3000,
                onOpen: toast => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            })

            var showRevise = {{ Data|safe }};

            var checkbox = {}
            

            

            item_check.addEventListener("click", function () {
                for(var key in showRevise){
                    var id_checkbox  = key + "_checkbox";
                    var id_name  = key + "_name";
                    var el_checkbox  = document.getElementById(id_checkbox)
                    var el_name   = document.getElementById(id_name)
                    checkbox[id_checkbox] = [el_checkbox.checked,el_name.value]
                }
                axios
                    .post("./item_check/", {checkbox
                    })
                    .then(function (resp) {
                        Toast.fire({
                            icon: 'success',
                            title: '儲存成功！'
                        })
                        console.log(resp)
                    })
                    .catch(function (resp) {
                        Toast.fire({
                            icon: 'error',
                            title: '儲存失敗！'
                        })
                        console.log(err);
                    })
            })
            table1_0.addEventListener("change", GetData)
            function GetData() {
                axios
                    .get("./GetTable/", { params: { "Item": table1_0.value } })
                    .then(function (resp) {
                        return resp.data;
                    })
                    .then(function (data) {
                        var Value_be = document.getElementById("Value_be");
                        var Value_af = document.getElementById("Value_af");
                        var a = document.getElementById("a");
                        var b = document.getElementById("b");
                        var offset = document.getElementById("offset");
                        Value_be.textContent = (data["Value_be"]).toFixed(3);
                        Value_af.textContent = (data["calValue_af"]).toFixed(3);
                        a.textContent = (data["a"]).toFixed(3);
                        b.textContent = (data["b"]).toFixed(3);
                        offset.textContent = data["offset"];

                    })
                    .catch(function (resp) {
                        Toast.fire({
                            icon: 'error',
                            title: '讀取失敗！'
                        })
                        console.log(err);
                    })
            }
            
            table_save.addEventListener("click", function () {
                var lsit_tab = []
                for (var j = 1; j < 6; j++) {
                    var ta = 'input'+ j;
                    lsit_tab.push(document.getElementById(ta))
                }
                axios
                    .post("./SaveTable/", { Item: table1_0.value, Value_zero: lsit_tab[0].value, Value_span: lsit_tab[1].value, Count_zero: lsit_tab[2].value, Count_span: lsit_tab[3].value, Offset: lsit_tab[4].value })
                    .then(function (data) {
                        var a = document.getElementById("a");
                        var b = document.getElementById("b");
                        var offset = document.getElementById("offset");
                        
                        a.textContent = (data.data['a']).toFixed(3);
                        b.textContent = (data.data['b']).toFixed(3);
                        offset.textContent = (data.data['Offset']).toFixed(3);
                        Toast.fire({
                            icon: 'success',
                            title: '儲存成功！'
                        })
                        console.log(data.data);
                    })
                    .catch(function (data) {
                        Toast.fire({
                            icon: 'error',
                            title: '儲存失敗！'
                        })
                        console.log(data);
                     })
                
            })
            function loop_check() {
                var table1_0 = document.getElementById("table1_0");
                setTimeout("loop_check()", 6000);
                if (table1_0.value != 1) {
                    GetData();

                }
            }


            loop_check()


        </script>
        {% endblock javascripts %}